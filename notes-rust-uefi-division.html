<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Investigating a Rust-on-UEFI division bug</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="favicon.png" />

    <script defer data-domain="nbishop.net" src="https://plausible.io/js/plausible.js"></script>
  </head>

  <body>
    <h1>Investigating a Rust-on-UEFI division bug</h1>

    <a class="content" href="index.html">Â« Home</a>
    <!-- Little hack: only show date if not on the home page -->
    <p class="content date">Created 2022-03-22, last updated 2022-07-10 02:52:26 UTC</p>
    <div class="content">
      <h2>2022-03-22</h2>
<p>These are some notes related to
<a href="https://github.com/rust-lang/rust/issues/86494">https://github.com/rust-lang/rust/issues/86494</a>. I filed that bug a
while ago but haven't followed up on it. The bug still repros so I
thought I'd take a look and see if I can give better information about
what's going wrong. I haven't done any work on the rust compiler itself
before, so I'll probably just be flailing around a bit.</p>
<p>It was suggested in the bug that the invalid instruction was maybe
caused by SSE being used, which wouldn't normally be allowed in a UEFI
environment. I think though that the invalid instruction is actually not
happening in the division per se, but rather due to hitting
<code>unreachable_unchecked</code> because it somehow thinks a division by zero is
occurring.</p>
<p>I suspect the problem is in <code>compiler_builtins</code>,
although it's certainly possible that rustc or llvm is at fault.</p>
<p>It's <a href="https://github.com/rust-lang/wg-cargo-std-aware/issues/61">not currently possible</a>
to use a custom <code>compiler_builtins</code> in your project's <code>Cargo.toml</code> in
combination with <code>build-std</code>. The current recommendation is to build
rust with the necessary customizations.</p>
<p>So, I have both <code>rust</code> and <code>compiler_builtins</code> checked out. I added this
to <code>Cargo.toml</code> in rust:</p>
<pre style="background-color:#eff1f5;"><code class="language-toml"><span style="color:#4f5b66;">[patch.crates-io]
</span><span style="color:#4f5b66;">compiler_builtins = { path = &quot;../compiler-builtins&quot; }
</span></code></pre>
<p>And ran <code>cargo update -p compiler_builtins</code> for good measure, not sure
if that's needed or not.</p>
<p>I set up <code>config.toml</code> like this, not at all sure if these are good
settings.</p>
<pre style="background-color:#eff1f5;"><code class="language-toml"><span style="color:#4f5b66;">profile = &quot;user&quot;
</span><span style="color:#4f5b66;">changelog-seen = 2
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[llvm]
</span><span style="color:#4f5b66;">download-ci-llvm = true
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[install]
</span><span style="color:#4f5b66;">prefix = &quot;/var/home/nbishop/src/rust/bishinstall&quot;
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[build]
</span><span style="color:#4f5b66;">target = [&quot;x86_64-unknown-uefi&quot;]
</span></code></pre>
<p>Aside: there's a lot of documentation, both in the <code>rust</code> repo and
linked to from it, e.g. the <a href="https://rustc-dev-guide.rust-lang.org/">Guide to Rustc
Development</a>, but I've found it
a bit challenging to navigate and find what I'm looking for. Certainly a
much better problem to have than not having documentation! But it's
still probably not as easy as it could be to get started with changing
things in Rust and I have to imagine that most people who give it a try
will bounce off the complexity pretty quickly and give up. (I may join
that group after failing at this for a bit, we'll see!) This is a
challenge that every big project faces of course, so absolutely no
judgement to the Rust folks on this, just noting there's more work to
do here.</p>
<p>Next, build stuff and see what breaks...</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">./x.py build
</span></code></pre>
<p>Lots of errors in <code>compiler_builtins</code>. I'll try checking out the version
that rust is currently pinned to <code>0.1.70</code> and build again. And that
fails the same way, hmm.</p>
<p>Ok, changing my <code>config.toml</code> to the <code>library</code> profile instead of
<code>user</code>, and then adding <code>#![feature(restricted_std)]</code> in
<code>library/test/src/lib.rs</code> got the build step to succeed. Then I ran
<code>./x.py install</code> to hopefully install it into the custom
prefix. Unexpectedly to me, that sent it back to compiling a bunch of
stuff instead of installing anything, and then it failed with the same
errors as before.</p>
<p>Ok, let's try throwing <code>#![allow(unexpected_cfgs)]</code> into
<code>compiler_builtins</code>'s <code>lib.rs</code>. Now it's blowing up in a whole new way:</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">thread &#39;rustc&#39; panicked at &#39;no entry found for key&#39;, compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs:525:9
</span></code></pre>
<p>Hmm. Maybe it's time to take a step back and do a clean build of
everything with a more stock config, because I have no idea what's going
wrong. I'll switch from my laptop to my desktop for quicker builds.</p>
<h2>2022-07-09</h2>
<p>The error I hit above was related to this issue: <a href="https://github.com/rust-lang/rust/issues/97322">https://github.com/rust-lang/rust/issues/97322</a></p>
<p>Using the patch in that bug I'm able to get past the error, and now <code>./x.py build</code> succeeds. Hooray!</p>
<p>To get <code>./x.py install</code> to work I had to change the <code>sysconfdir</code> to be
relative, turn off docs, and limit the set of tools being built. Now my
config looks like this:</p>
<pre style="background-color:#eff1f5;"><code class="language-toml"><span style="color:#4f5b66;">profile = &quot;user&quot;
</span><span style="color:#4f5b66;">changelog-seen = 2
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[llvm]
</span><span style="color:#4f5b66;">download-ci-llvm = true
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[install]
</span><span style="color:#4f5b66;">prefix = &quot;/var/home/nbishop/src/rust/bishinstall&quot;
</span><span style="color:#4f5b66;">sysconfdir = &quot;etc&quot;
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[build]
</span><span style="color:#4f5b66;">target = [&quot;x86_64-unknown-uefi&quot;]
</span><span style="color:#4f5b66;">docs = false
</span><span style="color:#4f5b66;">tools = [&quot;cargo&quot;]
</span></code></pre>
<p>Now it installs. Hooray! Unfortunately, compiling an actual project
fails because <code>build.rs</code>'s tend to expect <code>std</code> to be available. So I
guess maybe I need to build the <code>x86_64-unknown-linux-gnu</code> target in
addition to the uefi target?</p>
<p>Changed config to:</p>
<pre style="background-color:#eff1f5;"><code class="language-toml"><span style="color:#4f5b66;">profile = &quot;user&quot;
</span><span style="color:#4f5b66;">changelog-seen = 2
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[llvm]
</span><span style="color:#4f5b66;">download-ci-llvm = true
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[install]
</span><span style="color:#4f5b66;">prefix = &quot;/var/home/nbishop/src/rust/bishinstall&quot;
</span><span style="color:#4f5b66;">sysconfdir = &quot;etc&quot;
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[build]
</span><span style="color:#4f5b66;">target = [&quot;x86_64-unknown-linux-gnu&quot;, &quot;x86_64-unknown-uefi&quot;]
</span><span style="color:#4f5b66;">docs = false
</span><span style="color:#4f5b66;">tools = [&quot;cargo&quot;]
</span></code></pre>
<p>Reran <code>./x.py build</code> and <code>./x.py install</code>.</p>
<p>Those succeed, and I get a bit further with building a project, but it
fails at the link stage:</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">error: linker `rust-lld` not found
</span><span style="color:#4f5b66;">  |
</span><span style="color:#4f5b66;">  = note: No such file or directory (os error 2)
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">note: the msvc targets depend on the msvc linker but `link.exe` was not found
</span></code></pre>
<p>Let's try adding this to the config:</p>
<pre style="background-color:#eff1f5;"><code class="language-toml"><span style="color:#4f5b66;">[rust]
</span><span style="color:#4f5b66;">lld = true
</span></code></pre>
<p>Now <code>./x.py build</code> fails with:</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">CMake Error: The source directory &quot;/var/home/nbishop/src/rust/src/llvm-project/lld&quot; does not exist.
</span></code></pre>
<p>Let's try setting <code>download-ci-llvm = false</code> in the config. That's a big
change so <code>./x.py build</code> takes a long time, but it succeeds as does <code>install</code>.</p>
<p>Final config:</p>
<pre style="background-color:#eff1f5;"><code class="language-toml"><span style="color:#4f5b66;">profile = &quot;user&quot;
</span><span style="color:#4f5b66;">changelog-seen = 2
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[llvm]
</span><span style="color:#4f5b66;">download-ci-llvm = false
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[install]
</span><span style="color:#4f5b66;">prefix = &quot;/var/home/nbishop/src/rust/bishinstall&quot;
</span><span style="color:#4f5b66;">sysconfdir = &quot;etc&quot;
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[build]
</span><span style="color:#4f5b66;">target = [&quot;x86_64-unknown-linux-gnu&quot;, &quot;x86_64-unknown-uefi&quot;]
</span><span style="color:#4f5b66;">docs = false
</span><span style="color:#4f5b66;">tools = [&quot;cargo&quot;]
</span><span style="color:#4f5b66;">
</span><span style="color:#4f5b66;">[rust]
</span><span style="color:#4f5b66;">lld = true
</span></code></pre>
<p>Rust repo commit: 6c20ab744b0f82646d90ce9d25894823abc9c669</p>
<p>And now it works; I can build <a href="git@github.com:nicholasbishop/uefi-div-bug.git">uefi-div-bug</a> with:</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">PATH=&quot;/var/home/nbishop/src/rust/bishinstall/bin/:$PATH&quot; ./run.py 
</span></code></pre>
<p>At this point I remember that I forgot about overriding the
<code>compiler_builtins</code> dependency. I try adding it in as described above,
using <code>patch.crates-io</code>, and get a bunch of <code>unexpected-cfgs</code>
errors. Let's try this:</p>
<pre style="background-color:#eff1f5;"><code class="language-diff"><span style="color:#4f5b66;">diff --git a/src/bootstrap/builder.rs b/src/bootstrap/builder.rs
</span><span style="color:#4f5b66;">index fa6a5ee1668..ff59038fe18 100644
</span><span style="color:#4f5b66;">--- a/src/bootstrap/builder.rs
</span><span style="color:#4f5b66;">+++ b/src/bootstrap/builder.rs
</span><span style="color:#4f5b66;">@@ -1471,7 +1471,7 @@ pub fn cargo(
</span><span style="color:#4f5b66;">         // is made to work with `--check-cfg` which is currently not easly possible until cargo
</span><span style="color:#4f5b66;">         // get some support for setting `--check-cfg` within build script, it&#39;s the least invasive
</span><span style="color:#4f5b66;">         // hack that still let&#39;s us have cfg checking for the vast majority of the codebase.
</span><span style="color:#bf616a;">-        if stage != 0 {
</span><span style="color:#a3be8c;">+        if stage == 999 {
</span><span style="color:#4f5b66;">             // Enable cfg checking of cargo features for everything but std and also enable cfg
</span><span style="color:#4f5b66;">             // checking of names and values.
</span><span style="color:#4f5b66;">             //
</span></code></pre>
<p>New error, needed to initialize submodules in <code>compiler_builtins</code>.</p>
<p>With that fixed, the build works.</p>
<p><code>compiler_builtins</code> commit: 3872a7c38c64279374b46bed5c8dec45e0a5b4fd</p>
<p>So in theory, I can now make changes in compiler_builtins to try and fix the bug.</p>
<p>Unfortunately, any change to <code>compiler_builtins</code> triggers a huge rebuild
starting from <code>stage0 compiler artifacts</code>, so maybe this isn't a useful
method for fixing the problem.</p>
<hr />
<p>After putting the problem down for a few hours, I think I've found the
fix. Windows has a weird ABI for certain 128-bit integer intrinsics that
compiler-builtins handles with a special <code>win64_128bit_abi_hack</code>
attribute. That attribute wasn't being applied for
<code>x86_64-unknown-uefi</code>. Once I enabled it and rebuilt, the test project
was able to successfully do division!</p>
<p>Put up a PR here: <a href="https://github.com/rust-lang/compiler-builtins/pull/475">Enable win64_128bit_abi_hack for
x86_64-unknown-uefi</a></p>
<p>Assuming that it is merged, we'll need to update the version of
compiler-builtins in the rust repo and then we should be all good.</p>

    </div>

    <hr />

    <div class="content">
      Â© 2023 <a href="mailto:nbishop@nbishop.net">Nicholas Bishop</a>
      â¢
      <a href="index.html">Home</a>
      â¢
      <a href="https://github.com/nicholasbishop/nbishop-net">Repo</a>

      <!-- License -->
      <div id="license">
        Unless otherwise noted, content is licensed under
        <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a>.
        Code blocks are <em>additionally</em> available under
        <a href="https://creativecommons.org/share-your-work/public-domain/cc0">CC0</a> and
        <a href="https://www.apache.org/licenses/LICENSE-2.0.txt">Apache License version 2.0</a>
        at your option.
      </div>
    </div>
  </body>
</html>
